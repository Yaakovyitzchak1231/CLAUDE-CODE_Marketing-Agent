{
  "name": "Media Post-Processing Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "media/process",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-process-media",
      "name": "Webhook - Process Media",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "media-process-webhook"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM media_assets WHERE id = {{ $json.body.asset_id }}",
        "additionalFields": {}
      },
      "id": "get-media-asset",
      "name": "Get Media Asset",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [450, 300],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Marketing PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-image",
              "leftValue": "={{ $json.type }}",
              "rightValue": "image",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-image",
      "name": "If Image Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "method": "GET",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "download-media",
      "name": "Download Media File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [850, 300]
    },
    {
      "parameters": {
        "operation": "crop",
        "binaryPropertyName": "data",
        "cropPositionX": "={{ $('Webhook - Process Media').item.json.body.crop_x || 0 }}",
        "cropPositionY": "={{ $('Webhook - Process Media').item.json.body.crop_y || 0 }}",
        "width": "={{ $('Webhook - Process Media').item.json.body.crop_width }}",
        "height": "={{ $('Webhook - Process Media').item.json.body.crop_height }}",
        "options": {}
      },
      "id": "crop-image",
      "name": "Crop Image",
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [1050, 200]
    },
    {
      "parameters": {
        "operation": "resize",
        "binaryPropertyName": "data",
        "width": "={{ $('Webhook - Process Media').item.json.body.resize_width }}",
        "height": "={{ $('Webhook - Process Media').item.json.body.resize_height }}",
        "resizeOption": "={{ $('Webhook - Process Media').item.json.body.resize_mode || 'fitImage' }}",
        "options": {}
      },
      "id": "resize-image",
      "name": "Resize Image",
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [1050, 350]
    },
    {
      "parameters": {
        "operation": "filter",
        "binaryPropertyName": "data",
        "filterType": "={{ $('Webhook - Process Media').item.json.body.filter_type || 'none' }}",
        "options": {
          "brightness": "={{ $('Webhook - Process Media').item.json.body.brightness || 0 }}",
          "contrast": "={{ $('Webhook - Process Media').item.json.body.contrast || 0 }}",
          "saturation": "={{ $('Webhook - Process Media').item.json.body.saturation || 0 }}"
        }
      },
      "id": "apply-filter",
      "name": "Apply Image Filter",
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [1050, 500]
    },
    {
      "parameters": {
        "operation": "text",
        "binaryPropertyName": "data",
        "text": "={{ $('Webhook - Process Media').item.json.body.watermark_text || '' }}",
        "fontSize": "={{ $('Webhook - Process Media').item.json.body.watermark_size || 24 }}",
        "fontColor": "={{ $('Webhook - Process Media').item.json.body.watermark_color || '#FFFFFF' }}",
        "positionX": "={{ $('Webhook - Process Media').item.json.body.watermark_x || 20 }}",
        "positionY": "={{ $('Webhook - Process Media').item.json.body.watermark_y || 20 }}",
        "options": {
          "backgroundColor": "rgba(0,0,0,0.7)",
          "backgroundPadding": 10
        }
      },
      "id": "add-watermark-image",
      "name": "Add Watermark to Image",
      "type": "n8n-nodes-base.editImage",
      "typeVersion": 1,
      "position": [1250, 350]
    },
    {
      "parameters": {
        "url": "http://langchain-service:8001/tools/ffmpeg",
        "method": "POST",
        "bodyParametersJson": "={\n  \"operation\": \"trim\",\n  \"input_url\": \"{{ $('Get Media Asset').item.json.url }}\",\n  \"start_time\": {{ $('Webhook - Process Media').item.json.body.trim_start || 0 }},\n  \"end_time\": {{ $('Webhook - Process Media').item.json.body.trim_end }},\n  \"output_format\": \"mp4\"\n}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "trim-video",
      "name": "Trim Video",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1050, 650]
    },
    {
      "parameters": {
        "url": "http://langchain-service:8001/tools/ffmpeg",
        "method": "POST",
        "bodyParametersJson": "={\n  \"operation\": \"add_captions\",\n  \"input_url\": \"{{ $json.video_url }}\",\n  \"captions\": {{ $('Webhook - Process Media').item.json.body.captions || '[]' }},\n  \"font_size\": {{ $('Webhook - Process Media').item.json.body.caption_font_size || 24 }},\n  \"font_color\": \"{{ $('Webhook - Process Media').item.json.body.caption_color || 'white' }}\",\n  \"position\": \"{{ $('Webhook - Process Media').item.json.body.caption_position || 'bottom' }}\"\n}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "add-captions",
      "name": "Add Video Captions",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1250, 650]
    },
    {
      "parameters": {
        "url": "http://langchain-service:8001/tools/ffmpeg",
        "method": "POST",
        "bodyParametersJson": "={\n  \"operation\": \"add_audio\",\n  \"input_url\": \"{{ $json.video_url }}\",\n  \"audio_url\": \"{{ $('Webhook - Process Media').item.json.body.music_url }}\",\n  \"audio_volume\": {{ $('Webhook - Process Media').item.json.body.music_volume || 0.3 }},\n  \"fade_in\": {{ $('Webhook - Process Media').item.json.body.music_fade_in || 2 }},\n  \"fade_out\": {{ $('Webhook - Process Media').item.json.body.music_fade_out || 2 }}\n}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "add-music",
      "name": "Add Background Music",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1450, 650]
    },
    {
      "parameters": {
        "url": "http://langchain-service:8001/tools/ffmpeg",
        "method": "POST",
        "bodyParametersJson": "={\n  \"operation\": \"add_overlay\",\n  \"input_url\": \"{{ $json.video_url }}\",\n  \"overlay_url\": \"{{ $('Webhook - Process Media').item.json.body.watermark_image_url }}\",\n  \"position\": \"{{ $('Webhook - Process Media').item.json.body.watermark_position || 'top-right' }}\",\n  \"opacity\": {{ $('Webhook - Process Media').item.json.body.watermark_opacity || 0.7 }}\n}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "add-watermark-video",
      "name": "Add Watermark to Video",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [1650, 650]
    },
    {
      "parameters": {
        "jsCode": "// Save processed media and create edit record\nconst originalAsset = $('Get Media Asset').item.json;\nconst processedData = $input.item;\nconst editParams = $('Webhook - Process Media').item.json.body;\n\nconst filename = `processed_${Date.now()}_${Math.random().toString(36).substring(7)}.${originalAsset.type === 'image' ? 'png' : 'mp4'}`;\nconst filePath = `/app/media_assets/${filename}`;\n\nconst editRecord = {\n  asset_id: originalAsset.id,\n  edit_type: editParams.operation || 'composite',\n  edit_params: {\n    operations_applied: [],\n    original_dimensions: originalAsset.metadata_json?.dimensions || {},\n    edited_at: new Date().toISOString()\n  },\n  edited_file_path: filePath,\n  edited_url: `http://localhost:8000/media/${filename}`\n};\n\n// Track which operations were applied\nif (originalAsset.type === 'image') {\n  if (editParams.crop_width) editRecord.edit_params.operations_applied.push('crop');\n  if (editParams.resize_width) editRecord.edit_params.operations_applied.push('resize');\n  if (editParams.filter_type && editParams.filter_type !== 'none') editRecord.edit_params.operations_applied.push('filter');\n  if (editParams.watermark_text) editRecord.edit_params.operations_applied.push('watermark');\n  \n  editRecord.edit_params.final_dimensions = {\n    width: editParams.resize_width || editParams.crop_width || originalAsset.metadata_json?.dimensions?.width,\n    height: editParams.resize_height || editParams.crop_height || originalAsset.metadata_json?.dimensions?.height\n  };\n} else {\n  if (editParams.trim_start !== undefined || editParams.trim_end !== undefined) editRecord.edit_params.operations_applied.push('trim');\n  if (editParams.captions && editParams.captions.length > 0) editRecord.edit_params.operations_applied.push('captions');\n  if (editParams.music_url) editRecord.edit_params.operations_applied.push('music');\n  if (editParams.watermark_image_url) editRecord.edit_params.operations_applied.push('watermark');\n  \n  editRecord.edit_params.duration_seconds = editParams.trim_end ? \n    editParams.trim_end - (editParams.trim_start || 0) : \n    originalAsset.metadata_json?.duration_seconds;\n}\n\nreturn editRecord;"
      },
      "id": "prepare-edit-record",
      "name": "Prepare Edit Record",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 475]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "media_edits",
        "columns": "asset_id, edit_type, edit_params, edited_file_path, created_at",
        "returnFields": "id, asset_id, edited_file_path, edit_type",
        "additionalFields": {}
      },
      "id": "save-edit",
      "name": "Save Media Edit",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2050, 475],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Marketing PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "table": "media_assets",
        "updateKey": "id",
        "columns": "url",
        "additionalFields": {
          "additionalFields": [
            {
              "name": "updated_at",
              "value": "=NOW()"
            },
            {
              "name": "metadata_json",
              "value": "={{ $json.edit_params }}"
            }
          ]
        }
      },
      "id": "update-asset-url",
      "name": "Update Asset URL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [2050, 625],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "Marketing PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Media processed successfully\",\n  \"edit_id\": {{ $json.id }},\n  \"asset_id\": {{ $json.asset_id }},\n  \"edited_url\": \"{{ $json.edited_file_path }}\",\n  \"operations_applied\": {{ $json.edit_params.operations_applied }},\n  \"asset_type\": \"{{ $('Get Media Asset').item.json.type }}\",\n  \"original_url\": \"{{ $('Get Media Asset').item.json.url }}\",\n  \"preview_url\": \"http://localhost:8501/media_preview?edit_id={{ $json.id }}\"\n}",
        "options": {}
      },
      "id": "response-success",
      "name": "Respond Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2250, 475]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "media/batch-process",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-batch",
      "name": "Webhook - Batch Process",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 800],
      "webhookId": "batch-process-webhook"
    },
    {
      "parameters": {
        "mode": "multiplex"
      },
      "id": "split-batch",
      "name": "Split Asset Batch",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [450, 800]
    },
    {
      "parameters": {
        "url": "http://localhost:5678/webhook/media-process",
        "method": "POST",
        "bodyParametersJson": "={\n  \"asset_id\": {{ $json.asset_id }},\n  \"operation\": \"{{ $json.operation }}\",\n  \"crop_x\": {{ $json.crop_x }},\n  \"crop_y\": {{ $json.crop_y }},\n  \"crop_width\": {{ $json.crop_width }},\n  \"crop_height\": {{ $json.crop_height }},\n  \"resize_width\": {{ $json.resize_width }},\n  \"resize_height\": {{ $json.resize_height }},\n  \"filter_type\": \"{{ $json.filter_type }}\",\n  \"watermark_text\": \"{{ $json.watermark_text }}\"\n}",
        "options": {}
      },
      "id": "process-single-asset",
      "name": "Process Single Asset",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [650, 800]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge-batch-results",
      "name": "Merge Batch Results",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [850, 800]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\n  \"success\": true,\n  \"message\": \"Batch processing completed\",\n  \"total_assets\": {{ $json.length }},\n  \"processed_successfully\": {{ $json.filter(item => item.success).length }},\n  \"failed\": {{ $json.filter(item => !item.success).length }},\n  \"results\": {{ $json }}\n}",
        "options": {}
      },
      "id": "response-batch",
      "name": "Respond Batch Complete",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1050, 800]
    }
  ],
  "connections": {
    "Webhook - Process Media": {
      "main": [[{ "node": "Get Media Asset", "type": "main", "index": 0 }]]
    },
    "Get Media Asset": {
      "main": [[{ "node": "If Image Type", "type": "main", "index": 0 }]]
    },
    "If Image Type": {
      "main": [
        [{ "node": "Download Media File", "type": "main", "index": 0 }],
        [{ "node": "Trim Video", "type": "main", "index": 0 }]
      ]
    },
    "Download Media File": {
      "main": [
        [
          { "node": "Crop Image", "type": "main", "index": 0 },
          { "node": "Resize Image", "type": "main", "index": 0 },
          { "node": "Apply Image Filter", "type": "main", "index": 0 }
        ]
      ]
    },
    "Crop Image": {
      "main": [[{ "node": "Add Watermark to Image", "type": "main", "index": 0 }]]
    },
    "Resize Image": {
      "main": [[{ "node": "Add Watermark to Image", "type": "main", "index": 0 }]]
    },
    "Apply Image Filter": {
      "main": [[{ "node": "Add Watermark to Image", "type": "main", "index": 0 }]]
    },
    "Add Watermark to Image": {
      "main": [[{ "node": "Prepare Edit Record", "type": "main", "index": 0 }]]
    },
    "Trim Video": {
      "main": [[{ "node": "Add Video Captions", "type": "main", "index": 0 }]]
    },
    "Add Video Captions": {
      "main": [[{ "node": "Add Background Music", "type": "main", "index": 0 }]]
    },
    "Add Background Music": {
      "main": [[{ "node": "Add Watermark to Video", "type": "main", "index": 0 }]]
    },
    "Add Watermark to Video": {
      "main": [[{ "node": "Prepare Edit Record", "type": "main", "index": 0 }]]
    },
    "Prepare Edit Record": {
      "main": [[{ "node": "Save Media Edit", "type": "main", "index": 0 }]]
    },
    "Save Media Edit": {
      "main": [
        [
          { "node": "Update Asset URL", "type": "main", "index": 0 },
          { "node": "Respond Success", "type": "main", "index": 0 }
        ]
      ]
    },
    "Webhook - Batch Process": {
      "main": [[{ "node": "Split Asset Batch", "type": "main", "index": 0 }]]
    },
    "Split Asset Batch": {
      "main": [[{ "node": "Process Single Asset", "type": "main", "index": 0 }]]
    },
    "Process Single Asset": {
      "main": [[{ "node": "Merge Batch Results", "type": "main", "index": 0 }]]
    },
    "Merge Batch Results": {
      "main": [[{ "node": "Respond Batch Complete", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2024-01-15T00:00:00.000Z",
  "versionId": "1"
}
